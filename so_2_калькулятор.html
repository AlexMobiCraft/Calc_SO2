<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор K₂S₂O₅ (SO₂) на 100 л</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#7dd3fc; --glass: rgba(255,255,255,0.03);
      --radius:12px; --glass-2: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial; background:linear-gradient(180deg,#071022 0%, #081226 60%); color:#e6eef6}
    .wrap{max-width:920px;margin:36px auto;padding:28px;border-radius:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(2,6,23,0.7);}
    header{display:flex;gap:16px;align-items:center}
    h1{margin:0;font-size:20px}
    p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:22px}
    @media (max-width:880px){.grid{grid-template-columns:1fr} .right{order:2}}

    .card{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow: 0 4px 14px rgba(3,7,18,0.6)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
    input[type=number], input[type=text], select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}

    .row{display:flex;gap:12px;align-items:center}
    .row .col{flex:1}
    .radio{display:flex;gap:12px}
    .radio button{appearance:none}

    .switch{display:flex;align-items:center;gap:8px}
    .small{font-size:13px;color:var(--muted)}

    .result{font-weight:700;font-size:18px}
    .result-sub{color:var(--muted);font-size:13px}

    .actions{display:flex;gap:8px;margin-top:12px}
    button.btn{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#022; padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    pre.code{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;color:var(--muted);font-size:13px;overflow:auto}

    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .note{background:var(--glass-2);padding:10px;border-radius:10px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="flex:1">
        <h1>Калькулятор K₂S₂O₅ — доза на 100 литров</h1>
        <p class="lead">Введите pH сусла, выберите тип вина или укажите вручную желаемый молекулярный SO₂ (мг/л). Результат — граммы K₂S₂O₅ на 100 л и рассчитанный свободный SO₂.</p>
      </div>
      <div style="text-align:right;color:var(--muted);font-size:13px">pKa = 1.81 · фактор = 0.17544</div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <label for="ph">pH сусла</label>
          <input id="ph" type="number" step="0.01" min="2.5" max="5.0" value="3.4" />

          <div style="height:12px"></div>

          <label>Тип вина</label>
          <div class="row">
            <div class="radio col">
              <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="wine" value="white" checked /> Белое</label>
              <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="wine" value="red" /> Красное</label>
              <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="wine" value="custom" /> Пользовательский</label>
            </div>
          </div>

          <div style="height:12px"></div>

          <label for="molecular">Желаемый молекулярный SO₂ (мг/л)</label>
          <input id="molecular" type="number" step="0.01" min="0" max="5" value="0.8" />
          <div style="height:8px" class="small">По умолчанию: белое — 0.8 мг/л, красное — 0.5 мг/л. При выборе «Пользовательский» значение можно ввести вручную.</div>

          <div style="height:14px"></div>

          <div class="actions">
            <button id="calc" class="btn">Рассчитать</button>
            <button id="reset" class="ghost">Сброс</button>
            <button id="copy" class="ghost">Скопировать результат</button>
          </div>

          <div style="height:12px"></div>

          <div id="output" class="note">
            <div class="result" id="gres">— г / 100 л</div>
            <div class="result-sub" id="freeso2">— mg/L свободного SO₂ (free SO₂)</div>
          </div>

        </div>

        <div style="height:14px"></div>

        <div class="card">
          <strong>Формулы</strong>
          <pre class="code">M = 1 + 10^(pH - pKa)
free_SO2 = molecular_SO2 * M   (мг/л)
g K2S2O5 /100L = free_SO2 * 0.17544
pKa = 1.81 (по умолчанию)
</pre>
          <div style="height:8px"></div>
          <div class="small">Примечание: 0.17544 = (100 л × 1 мг/л × 1 г/1000мг) / 0.57, где 0.57 — доля SO₂ в метабисульфите K₂S₂O₅ (~57%). Измеряйте свободный SO₂ после внесения и корректируйте при необходимости.</div>
        </div>

      </div>

      <aside class="right">
        <div class="card">
          <h3 style="margin-top:0">Быстрые подсказки</h3>
          <ul style="color:var(--muted);line-height:1.6">
            <li>Для белых вин обычно 0.6–1.0 мг/л молекулярного SO₂, для красных 0.4–0.6 мг/л.</li>
            <li>Если pH ≥ 3.6, подумайте о корректировке кислотности — иначе потребуется много SO₂.</li>
            <li>Не превышайте заметные вкусовые уровни free SO₂; ориентируйтесь на измерения после внесения.</li>
          </ul>

          <div style="height:14px"></div>

          <div class="note">
            <div style="font-weight:700">Пример</div>
            <div class="small" id="example">pH 3.4, белое, target 0.8 → …</div>
          </div>

          <div style="height:14px"></div>

          <div class="card" style="background:transparent;padding:0;box-shadow:none">
            <label for="precision">Округление (знаков после запятой)</label>
            <input id="precision" type="number" min="0" max="4" value="2" />
          </div>
        </div>

      </aside>
    </div>

    <footer>
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap">
        <div>Автор: Калькулятор — расчет дозы метабисульфита</div>
        <div style="color:var(--muted)">pKa = 1.81, доля SO₂ в K₂S₂O₅ ≈ 57%</div>
      </div>
    </footer>
  </div>

  <script>
    const pKa = 1.81;
    const FACTOR = 0.17544; // free SO2 (mg/L) -> g K2S2O5 per 100L

    const phInput = document.getElementById('ph');
    const molecularInput = document.getElementById('molecular');
    const calcBtn = document.getElementById('calc');
    const resetBtn = document.getElementById('reset');
    const copyBtn = document.getElementById('copy');
    const gres = document.getElementById('gres');
    const frees = document.getElementById('freeso2');
    const example = document.getElementById('example');
    const precisionInput = document.getElementById('precision');

    function getWineType(){
      const radios = document.querySelectorAll('input[name="wine"]');
      for(const r of radios) if(r.checked) return r.value;
      return 'white';
    }

    function applyTypeDefaults(){
      const t = getWineType();
      if(t === 'white') molecularInput.value = 0.8;
      else if(t === 'red') molecularInput.value = 0.5;
      // if custom — keep current value
    }

    document.querySelectorAll('input[name="wine"]').forEach(el=>el.addEventListener('change', ()=>{
      applyTypeDefaults();
    }));

    function calculate(){
      const ph = parseFloat(phInput.value);
      let molecular = parseFloat(molecularInput.value);
      const prec = parseInt(precisionInput.value) || 2;
      if(Number.isNaN(ph) || ph <= 0){ alert('Введите корректный pH'); return; }
      if(Number.isNaN(molecular) || molecular < 0){ alert('Введите корректное значение молекулярного SO₂'); return; }

      const M = 1 + Math.pow(10, ph - pKa);
      const freeSO2 = molecular * M; // mg/L
      const gramsPer100l = freeSO2 * FACTOR; // g/100L

      gres.textContent = gramsPer100l.toFixed(prec) + ' г / 100 л';
      frees.textContent = freeSO2.toFixed(prec) + ' mg/L свободного SO₂';

      example.textContent = `pH ${ph.toFixed(2)}, target ${molecular} мг/л → ${gramsPer100l.toFixed(prec)} г K₂S₂O₅ /100л (free SO₂ ${freeSO2.toFixed(prec)} мг/л)`;
    }

    calcBtn.addEventListener('click', calculate);
    resetBtn.addEventListener('click', ()=>{
      phInput.value = '3.4';
      document.querySelector('input[name="wine"][value="white"]').checked = true;
      molecularInput.value = '0.8';
      precisionInput.value = '2';
      gres.textContent = '— г / 100 л';
      frees.textContent = '— mg/L свободного SO₂ (free SO₂)';
      example.textContent = 'pH 3.4, белое, target 0.8 → …';
    });

    copyBtn.addEventListener('click', ()=>{
      const text = `${gres.textContent}\n${frees.textContent}\n(pH ${phInput.value})`;
      navigator.clipboard?.writeText(text).then(()=>{
        copyBtn.textContent = 'Скопировано!';
        setTimeout(()=> copyBtn.textContent = 'Скопировать результат',1200);
      }).catch(()=> alert('Не удалось скопировать в буфер обмена'));
    });

    // initial apply
    applyTypeDefaults();
    calculate();
  </script>
</body>
</html>
